-- ============================================================
-- SEED EXPANSION — Run AFTER supabase-setup.sql
-- ============================================================
-- Adds:
--   1. Week 1 payroll (Feb 3-9, closed) — overtime baseline
--   2. Proration setup — d17 start_date → mid-current-week
--   3. Trips for d17 (prorated driver) in current week
--   4. Shifts for current week (active + completed)
-- ============================================================


-- ============================================================
-- 1. WEEK 1 PAYROLL (Feb 3-9, 2026) — Closed
-- ============================================================
-- No overtime possible this week (no previous week data).
-- Establishes baseline hours for Week 2 overtime eligibility.

-- Goal met (18 drivers — same set as Week 2)
INSERT INTO weekly_payroll (driver_id, week_start, week_end, hours_worked, total_billed, tips_total, hours_threshold, revenue_threshold, goal_met, base_salary, productivity_bonus, overtime_pay, total_pay, status, version, closed_by, closed_at) VALUES
  ('00000000-0000-0000-0000-0000000d0001', '2026-02-03', '2026-02-09', 44.00, 8800.00, 0, 40, 6000, true,  2500.00, 500.00, 0, 3000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0002', '2026-02-03', '2026-02-09', 41.00, 6500.00, 0, 40, 6000, true,  2500.00, 100.00, 0, 2600.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0004', '2026-02-03', '2026-02-09', 43.00, 8200.00, 0, 40, 6000, true,  2500.00, 400.00, 0, 2900.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0005', '2026-02-03', '2026-02-09', 40.00, 6100.00, 0, 40, 6000, true,  2500.00,   0.00, 0, 2500.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0006', '2026-02-03', '2026-02-09', 42.00, 7500.00, 0, 40, 6000, true,  2500.00, 300.00, 0, 2800.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0007', '2026-02-03', '2026-02-09', 45.00, 9100.00, 0, 40, 6000, true,  2500.00, 600.00, 0, 3100.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0008', '2026-02-03', '2026-02-09', 40.00, 6000.00, 0, 40, 6000, true,  2500.00,   0.00, 0, 2500.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0012', '2026-02-03', '2026-02-09', 40.00, 6200.00, 0, 40, 6000, true,  2500.00,   0.00, 0, 2500.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0013', '2026-02-03', '2026-02-09', 43.00, 8000.00, 0, 40, 6000, true,  2500.00, 400.00, 0, 2900.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0014', '2026-02-03', '2026-02-09', 40.00, 6300.00, 0, 40, 6000, true,  2500.00,   0.00, 0, 2500.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0018', '2026-02-03', '2026-02-09', 47.00, 9800.00, 0, 40, 6000, true,  2500.00, 700.00, 0, 3200.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0019', '2026-02-03', '2026-02-09', 41.00, 6100.00, 0, 40, 6000, true,  2500.00,   0.00, 0, 2500.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0021', '2026-02-03', '2026-02-09', 42.00, 6800.00, 0, 40, 6000, true,  2500.00, 100.00, 0, 2600.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0024', '2026-02-03', '2026-02-09', 41.00, 7000.00, 0, 40, 6000, true,  2500.00, 200.00, 0, 2700.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0025', '2026-02-03', '2026-02-09', 44.00, 8500.00, 0, 40, 6000, true,  2500.00, 500.00, 0, 3000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0026', '2026-02-03', '2026-02-09', 40.00, 6050.00, 0, 40, 6000, true,  2500.00,   0.00, 0, 2500.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0027', '2026-02-03', '2026-02-09', 42.00, 6700.00, 0, 40, 6000, true,  2500.00, 100.00, 0, 2600.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0028', '2026-02-03', '2026-02-09', 41.00, 6200.00, 0, 40, 6000, true,  2500.00,   0.00, 0, 2500.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00');

-- Goal not met (12 drivers)
INSERT INTO weekly_payroll (driver_id, week_start, week_end, hours_worked, total_billed, tips_total, hours_threshold, revenue_threshold, goal_met, base_salary, productivity_bonus, overtime_pay, total_pay, status, version, closed_by, closed_at) VALUES
  ('00000000-0000-0000-0000-0000000d0003', '2026-02-03', '2026-02-09', 36.00, 6800.00, 0, 40, 6000, false, 0, 0, 0, 1000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0009', '2026-02-03', '2026-02-09', 41.00, 5500.00, 0, 40, 6000, false, 0, 0, 0, 1000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0010', '2026-02-03', '2026-02-09', 39.00, 5800.00, 0, 40, 6000, false, 0, 0, 0, 1000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0011', '2026-02-03', '2026-02-09', 28.00, 3200.00, 0, 40, 6000, false, 0, 0, 0, 1000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0015', '2026-02-03', '2026-02-09', 34.00, 5200.00, 0, 40, 6000, false, 0, 0, 0, 1000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0016', '2026-02-03', '2026-02-09', 30.00, 3000.00, 0, 40, 6000, false, 0, 0, 0, 1000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0017', '2026-02-03', '2026-02-09', 18.00, 2500.00, 0, 40, 6000, false, 0, 0, 0, 1000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0020', '2026-02-03', '2026-02-09', 38.00, 6500.00, 0, 40, 6000, false, 0, 0, 0, 1000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0022', '2026-02-03', '2026-02-09', 39.00, 5000.00, 0, 40, 6000, false, 0, 0, 0, 1000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0023', '2026-02-03', '2026-02-09',  8.00, 1200.00, 0, 40, 6000, false, 0, 0, 0, 1000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0029', '2026-02-03', '2026-02-09', 33.00, 4500.00, 0, 40, 6000, false, 0, 0, 0, 1000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00'),
  ('00000000-0000-0000-0000-0000000d0030', '2026-02-03', '2026-02-09', 16.00, 2000.00, 0, 40, 6000, false, 0, 0, 0, 1000.00, 'cerrado', 1, '00000000-0000-0000-0000-00000000a001', '2026-02-09T20:00:00+00:00');


-- ============================================================
-- 2. PRORATION SETUP — Sergio Guzmán starts mid-current-week
-- ============================================================
-- Change d17 start_date from Feb 10 → Feb 18 (Wednesday of current week).
-- This means: 3 working days (Wed, Thu, Fri) / 5 = 60% proration.
-- Prorated thresholds: 24h hours, $3,600 revenue.
-- Remove his Week 1 and Week 2 payroll (he didn't exist yet).

DELETE FROM weekly_payroll
  WHERE driver_id = '00000000-0000-0000-0000-0000000d0017'
    AND week_start IN ('2026-02-03', '2026-02-10');

UPDATE drivers
  SET start_date = '2026-02-18'
  WHERE id = '00000000-0000-0000-0000-0000000d0017';


-- ============================================================
-- 3. TRIPS FOR d17 (prorated driver) — Current week
-- ============================================================
-- 3 working days of trips: ~$4,200 total, ~25h via shifts.
-- Meets prorated goal ($3,600) but NOT full goal ($6,000).
-- With proration: goalMet=true, base=$2,500, bonus=floor((4200-3600)/500)*100=$100.
-- Without proration: goalMet=false, totalPay=$1,000.

INSERT INTO trips (driver_id, didi_trip_id, date, initial_time, final_time, cost, tip) VALUES
  ('00000000-0000-0000-0000-0000000d0017', 'sg-w3-01', '2026-02-18', '05:30', '17:00', 1450.00, 0.00),
  ('00000000-0000-0000-0000-0000000d0017', 'sg-w3-02', '2026-02-19', '05:30', '17:30', 1380.00, 0.00),
  ('00000000-0000-0000-0000-0000000d0017', 'sg-w3-03', '2026-02-20', '05:15', '17:15', 1370.00, 40.00);


-- ============================================================
-- 4. ADDITIONAL EDGE CASE TRIPS
-- ============================================================
-- d12 (Raúl Vargas, 114969): exactly $6,000 billing — boundary case
INSERT INTO trips (driver_id, didi_trip_id, date, initial_time, final_time, cost, tip) VALUES
  ('00000000-0000-0000-0000-0000000d0012', 'rv-w3-01', '2026-02-16', '05:30', '17:30', 1520.00, 0.00),
  ('00000000-0000-0000-0000-0000000d0012', 'rv-w3-02', '2026-02-17', '05:15', '17:00', 1480.00, 30.00),
  ('00000000-0000-0000-0000-0000000d0012', 'rv-w3-03', '2026-02-18', '05:45', '17:15', 1540.00, 0.00),
  ('00000000-0000-0000-0000-0000000d0012', 'rv-w3-04', '2026-02-19', '05:30', '17:30', 1460.00, 0.00);
-- Total: $6,000.00 exactly

-- d15 (Eduardo Ríos, 114972): $5,999.50 — misses goal by $0.50
INSERT INTO trips (driver_id, didi_trip_id, date, initial_time, final_time, cost, tip) VALUES
  ('00000000-0000-0000-0000-0000000d0015', 'er-w3-01', '2026-02-16', '05:30', '17:30', 1520.00, 0.00),
  ('00000000-0000-0000-0000-0000000d0015', 'er-w3-02', '2026-02-17', '05:15', '17:00', 1479.50, 50.00),
  ('00000000-0000-0000-0000-0000000d0015', 'er-w3-03', '2026-02-18', '05:45', '17:15', 1540.00, 0.00),
  ('00000000-0000-0000-0000-0000000d0015', 'er-w3-04', '2026-02-19', '05:30', '17:30', 1460.00, 0.00);
-- Total: $5,999.50 (tips excluded from threshold)

-- d20 (Iván Contreras, 114977): includes midnight-crossing trip
INSERT INTO trips (driver_id, didi_trip_id, date, initial_time, final_time, cost, tip) VALUES
  ('00000000-0000-0000-0000-0000000d0020', 'ic-w3-01', '2026-02-16', '19:00', '07:00', 1680.00, 0.00),
  ('00000000-0000-0000-0000-0000000d0020', 'ic-w3-02', '2026-02-17', '23:50', '00:35', 185.00, 0.00),
  ('00000000-0000-0000-0000-0000000d0020', 'ic-w3-03', '2026-02-18', '19:00', '07:00', 1720.00, 0.00),
  ('00000000-0000-0000-0000-0000000d0020', 'ic-w3-04', '2026-02-19', '19:00', '07:00', 1590.00, 0.00),
  ('00000000-0000-0000-0000-0000000d0020', 'ic-w3-05', '2026-02-20', '19:00', '07:00', 1650.00, 0.00);
-- Midnight trip validates Bug C fix

-- d26 (Javier Reyes, 114983): high-tip trips — tips excluded from $6K
INSERT INTO trips (driver_id, didi_trip_id, date, initial_time, final_time, cost, tip) VALUES
  ('00000000-0000-0000-0000-0000000d0026', 'jr-w3-01', '2026-02-16', '19:00', '07:00', 1380.00, 75.00),
  ('00000000-0000-0000-0000-0000000d0026', 'jr-w3-02', '2026-02-17', '19:00', '07:00', 1420.00, 60.00),
  ('00000000-0000-0000-0000-0000000d0026', 'jr-w3-03', '2026-02-18', '19:00', '07:00', 1350.00, 80.00),
  ('00000000-0000-0000-0000-0000000d0026', 'jr-w3-04', '2026-02-19', '19:00', '07:00', 1450.00, 0.00);
-- Cost total: $5,600 (goal NOT met). Tips total: $215 (excluded from threshold).
-- With tips: $5,815 — still below $6K. Verifies tips not counted.


-- ============================================================
-- 5. SHIFTS — Current week (Feb 16-22)
-- ============================================================
-- Active shifts (en_turno) — currently driving
INSERT INTO shifts (id, driver_id, vehicle_id, check_in, status, created_by) VALUES
  ('00000000-0000-0000-0000-0000005f0001', '00000000-0000-0000-0000-0000000d0001', '00000000-0000-0000-0000-0000000b0002', '2026-02-18T05:30:00-06:00', 'en_turno', '00000000-0000-0000-0000-00000000a001'),
  ('00000000-0000-0000-0000-0000005f0002', '00000000-0000-0000-0000-0000000d0003', '00000000-0000-0000-0000-0000000b0003', '2026-02-18T19:00:00-06:00', 'en_turno', '00000000-0000-0000-0000-00000000a002'),
  ('00000000-0000-0000-0000-0000005f0003', '00000000-0000-0000-0000-0000000d0004', '00000000-0000-0000-0000-0000000b0004', '2026-02-18T05:30:00-06:00', 'en_turno', '00000000-0000-0000-0000-00000000a001'),
  ('00000000-0000-0000-0000-0000005f0004', '00000000-0000-0000-0000-0000000d0018', '00000000-0000-0000-0000-0000000b0005', '2026-02-18T19:00:00-06:00', 'en_turno', '00000000-0000-0000-0000-00000000a003'),
  ('00000000-0000-0000-0000-0000005f0005', '00000000-0000-0000-0000-0000000d0007', '00000000-0000-0000-0000-0000000b0007', '2026-02-18T05:30:00-06:00', 'en_turno', '00000000-0000-0000-0000-00000000a001'),
  ('00000000-0000-0000-0000-0000005f0006', '00000000-0000-0000-0000-0000000d0008', '00000000-0000-0000-0000-0000000b0010', '2026-02-18T19:00:00-06:00', 'en_turno', '00000000-0000-0000-0000-00000000a004');

-- Alert shift — open >12h (forgot to check out)
INSERT INTO shifts (id, driver_id, vehicle_id, check_in, status, created_by) VALUES
  ('00000000-0000-0000-0000-0000005f0007', '00000000-0000-0000-0000-0000000d0014', '00000000-0000-0000-0000-0000000b0011', '2026-02-17T19:00:00-06:00', 'en_turno', '00000000-0000-0000-0000-00000000a002');

-- Completed shifts (today)
INSERT INTO shifts (id, driver_id, vehicle_id, check_in, check_out, hours_worked, status, created_by) VALUES
  ('00000000-0000-0000-0000-0000005f0010', '00000000-0000-0000-0000-0000000d0002', '00000000-0000-0000-0000-0000000b0002', '2026-02-17T05:30:00-06:00', '2026-02-17T17:30:00-06:00', 12.00, 'completado', '00000000-0000-0000-0000-00000000a002'),
  ('00000000-0000-0000-0000-0000005f0011', '00000000-0000-0000-0000-0000000d0005', '00000000-0000-0000-0000-0000000b0012', '2026-02-17T19:00:00-06:00', '2026-02-18T07:00:00-06:00', 12.00, 'completado', '00000000-0000-0000-0000-00000000a003'),
  ('00000000-0000-0000-0000-0000005f0012', '00000000-0000-0000-0000-0000000d0013', '00000000-0000-0000-0000-0000000b0003', '2026-02-17T05:30:00-06:00', '2026-02-17T17:00:00-06:00', 11.50, 'completado', '00000000-0000-0000-0000-00000000a002'),
  ('00000000-0000-0000-0000-0000005f0013', '00000000-0000-0000-0000-0000000d0025', '00000000-0000-0000-0000-0000000b0008', '2026-02-17T05:30:00-06:00', '2026-02-17T17:30:00-06:00', 12.00, 'completado', '00000000-0000-0000-0000-00000000a004');

-- Completed shifts (previous days this week)
INSERT INTO shifts (id, driver_id, vehicle_id, check_in, check_out, hours_worked, status, created_by) VALUES
  ('00000000-0000-0000-0000-0000005f0020', '00000000-0000-0000-0000-0000000d0001', '00000000-0000-0000-0000-0000000b0002', '2026-02-16T05:30:00-06:00', '2026-02-16T17:30:00-06:00', 12.00, 'completado', '00000000-0000-0000-0000-00000000a002'),
  ('00000000-0000-0000-0000-0000005f0021', '00000000-0000-0000-0000-0000000d0001', '00000000-0000-0000-0000-0000000b0002', '2026-02-17T05:15:00-06:00', '2026-02-17T17:00:00-06:00', 11.75, 'completado', '00000000-0000-0000-0000-00000000a002'),
  ('00000000-0000-0000-0000-0000005f0022', '00000000-0000-0000-0000-0000000d0004', '00000000-0000-0000-0000-0000000b0004', '2026-02-16T05:30:00-06:00', '2026-02-16T17:30:00-06:00', 12.00, 'completado', '00000000-0000-0000-0000-00000000a003'),
  ('00000000-0000-0000-0000-0000005f0023', '00000000-0000-0000-0000-0000000d0004', '00000000-0000-0000-0000-0000000b0004', '2026-02-17T05:15:00-06:00', '2026-02-17T17:15:00-06:00', 12.00, 'completado', '00000000-0000-0000-0000-00000000a003'),
  ('00000000-0000-0000-0000-0000005f0024', '00000000-0000-0000-0000-0000000d0007', '00000000-0000-0000-0000-0000000b0007', '2026-02-16T05:30:00-06:00', '2026-02-16T17:00:00-06:00', 11.50, 'completado', '00000000-0000-0000-0000-00000000a004'),
  ('00000000-0000-0000-0000-0000005f0025', '00000000-0000-0000-0000-0000000d0007', '00000000-0000-0000-0000-0000000b0007', '2026-02-17T05:15:00-06:00', '2026-02-17T17:30:00-06:00', 12.25, 'completado', '00000000-0000-0000-0000-00000000a004'),
  ('00000000-0000-0000-0000-0000005f0026', '00000000-0000-0000-0000-0000000d0018', '00000000-0000-0000-0000-0000000b0005', '2026-02-16T19:00:00-06:00', '2026-02-17T07:00:00-06:00', 12.00, 'completado', '00000000-0000-0000-0000-00000000a003'),
  ('00000000-0000-0000-0000-0000005f0027', '00000000-0000-0000-0000-0000000d0018', '00000000-0000-0000-0000-0000000b0005', '2026-02-17T19:00:00-06:00', '2026-02-18T07:00:00-06:00', 12.00, 'completado', '00000000-0000-0000-0000-00000000a003');


-- ============================================================
-- 6. UPDATE WEEK 2 PAYROLL with hours_threshold / revenue_threshold
-- ============================================================
-- The original seed doesn't set these columns. Update with defaults.
-- Most drivers have 40h/6000; prorated driver d17 was deleted above.

UPDATE weekly_payroll
  SET hours_threshold = 40, revenue_threshold = 6000
  WHERE week_start = '2026-02-10'
    AND hours_threshold IS NULL;


-- ============================================================
-- Done. Verify expanded data with:
--   SELECT week_start, count(*) FROM weekly_payroll GROUP BY week_start ORDER BY week_start;
--   SELECT status, count(*) FROM shifts GROUP BY status;
--   SELECT count(*) FROM trips;
--
-- Expected:
--   weekly_payroll: Feb 3 = 30, Feb 10 = 28 (d17 removed)
--   shifts: en_turno = 7, completado = 12
--   trips: 60 (original) + 3 (d17) + 4 (d12) + 4 (d15) + 5 (d20) + 4 (d26) = 80
-- ============================================================
